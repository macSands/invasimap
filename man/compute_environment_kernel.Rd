% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/compute_environment_kernel.R
\name{compute_environment_kernel}
\alias{compute_environment_kernel}
\title{Environmental optima and site-species environmental distance (with optional kernel)}
\usage{
compute_environment_kernel(
  site_env,
  abundance_wide = NULL,
  predictions = NULL,
  site_col = "site_id",
  env_cols = NULL,
  coord_cols = c("x", "y"),
  method = c("gower", "euclidean", "manhattan"),
  gower_stand = TRUE,
  kernel = c("distance", "similarity", "gaussian"),
  sigma_e = NULL,
  sigma_method = c("sd", "median", "iqr"),
  scale_01 = TRUE
)
}
\arguments{
\item{site_env}{data.frame. One row per site; must include \code{site_col} and the
environmental variables (numeric/factor/ordered). Coordinate columns can be present.}

\item{abundance_wide}{matrix/data.frame or NULL. \strong{Sites × species} numeric
abundance/weight table (rows = sites, columns = species). If \code{NULL}, provide
\code{predictions} instead.}

\item{predictions}{data.frame or NULL. Long table with columns \code{species},
\code{site_id}, and \code{pred} to construct \code{abundance_wide} internally.}

\item{site_col}{character. Site identifier column in \code{site_env} (and \code{predictions}). Default \code{"site_id"}.}

\item{env_cols}{NULL or character. Environmental columns in \code{site_env}. If \code{NULL},
auto-detect as all non-\code{site_col} non-coordinate columns.}

\item{coord_cols}{character. Columns to exclude from env detection (e.g., coords). Default \code{c("x","y")}.}

\item{method}{character. Distance metric for site-optimum comparison: \code{"gower"} (default),
\code{"euclidean"}, or \code{"manhattan"}.}

\item{gower_stand}{logical. Standardise numeric vars inside Gower (default \code{TRUE}).}

\item{kernel}{character. One of \code{"distance"} (no transform), \code{"similarity"} (1 - scaled distance),
or \code{"gaussian"} (Gaussian kernel). Default \code{"distance"}.}

\item{sigma_e}{numeric or NULL. Bandwidth for Gaussian kernel. If \code{NULL}, estimated from
non-zero \code{env_dist} using \code{sigma_method}.}

\item{sigma_method}{character. How to estimate \code{sigma_e} when missing: \code{"sd"} (default),
\code{"median"}, or \code{"iqr"}.}

\item{scale_01}{logical. Min-max scale distances to \link{0,1} \strong{before} \code{"similarity"};
for non-Gower metrics only, this is applied automatically if needed.}
}
\value{
A list with:
\itemize{
\item \code{env_opt}: \strong{species × env} matrix of abundance-weighted optima.
\item \code{env_dist}: \strong{sites × species} distance matrix (site ↔ species-optimum).
\item \code{K_env}: \strong{sites × species} kernel (if \code{kernel != "distance"}).
\item \code{sigma_e}: bandwidth used (if Gaussian).
\item \code{meta}: list of settings and detected columns.
}
}
\description{
Estimates each species’ \strong{environmental optimum} as the abundance-weighted mean of
site-level environmental covariates, then computes the \strong{distance} (default: Gower)
between every \strong{site} and every \strong{species optimum}. Optionally returns an
\strong{environmental kernel} (similarity) by transforming distances (e.g., Gaussian).
}
\details{
Let \eqn{E_s} be the vector of environmental covariates at site \eqn{s}, and
\eqn{w_{s,j}} the abundance (weight) of species \eqn{j} at site \eqn{s}. The
environmental \strong{optimum} for species \eqn{j} is
\deqn{ \mu_j \;=\; \frac{\sum_s w_{s,j} \, E_s}{\sum_s w_{s,j}}. }
The \strong{environmental distance} between site \eqn{s} and species \eqn{j} is then
\eqn{d_{s j} = \mathrm{Gower}(E_s, \mu_j)} (or another supported metric).

The optional \strong{kernel} converts distances to similarity, e.g., Gaussian
\eqn{K_{sj} = \exp\{-d_{sj}^2/(2 \sigma_e^2)\}}. The bandwidth \eqn{\sigma_e}
controls how quickly suitability decays with mismatch; by default we estimate
\eqn{\sigma_e} from the distribution of \eqn{d_{sj}}.
}
\examples{
# --- Simulate sites, environments, and species weights (no extra packages) ---
set.seed(123)

# Sites and species
n_sites <- 6
n_spp   <- 4
sites   <- paste0("s", seq_len(n_sites))
spp     <- paste0("sp", seq_len(n_spp))

# Site-level environment table (include optional coord columns)
site_env <- data.frame(
  site_id = sites,
  x       = rnorm(n_sites),
  y       = rnorm(n_sites),
  temp    = runif(n_sites, 5, 25),     # numeric env var
  precip  = runif(n_sites, 400, 900),  # numeric env var
  check.names = FALSE
)

# Sites × species abundance/weights (any non-negative numbers)
abundance_wide <- matrix(
  rexp(n_sites * n_spp, rate = 1),
  nrow = n_sites, ncol = n_spp,
  dimnames = list(sites, spp)
)

# Compute environmental optima and site–species distances
ek <- compute_environment_kernel(
  site_env       = site_env,
  abundance_wide = abundance_wide,   # avoids needing tidyr
  site_col       = "site_id",
  method         = "euclidean",      # uses stats::dist (no extra deps)
  kernel         = "gaussian",       # also returns K_env
  sigma_method   = "sd"
)

# Inspect results
str(ek$env_opt)       # species × env optima
dim(ek$env_dist)      # sites × species distance matrix
if (!is.null(ek$K_env)) range(ek$K_env, na.rm = TRUE)

# (Optional) If you prefer Gower distances, set method = "gower".
# This uses cluster::daisy internally and may require the 'cluster' package:
# ek_gower <- compute_environment_kernel(
#   site_env       = site_env,
#   abundance_wide = abundance_wide,
#   site_col       = "site_id",
#   method         = "gower",
#   kernel         = "similarity"
# )

}
