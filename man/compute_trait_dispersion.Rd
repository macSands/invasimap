% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/compute_trait_dispersion.R
\name{compute_trait_dispersion}
\alias{compute_trait_dispersion}
\title{Trait Dispersion Pipeline: Gower → clustering → PCoA → density → metrics}
\usage{
compute_trait_dispersion(
  trait_df,
  species_col = 1,
  k = 4,
  pcoa_dims = 2,
  abundance = NULL,
  kde_n = 100,
  viridis_option = "D",
  show_density_plot = TRUE,
  show_plots = FALSE,
  seed = NULL
)
}
\arguments{
\item{trait_df}{data.frame. One row per species (or unit); mixed types allowed.}

\item{species_col}{integer or character (default = 1). Column to exclude from distance.}

\item{k}{integer (default = 4). Number of clusters in dendrogram.}

\item{pcoa_dims}{integer (default = 2). PCoA axes retained (≥ 2).}

\item{abundance}{numeric vector or NULL. Optional species weights; normalized internally.}

\item{kde_n}{integer (default = 100). KDE grid resolution for density.}

\item{viridis_option}{character (default = "D"). Palette option for \code{viridisLite::viridis}.}

\item{show_density_plot}{logical (default = TRUE). Also compute a base \code{filled.contour}.}

\item{show_plots}{logical (default = FALSE). If TRUE, prints a portrait patchwork of all ggplots.}

\item{seed}{integer or NULL. Optional RNG seed.}
}
\value{
A list with components:
\itemize{
\item \code{distance_matrix} (matrix), \code{hc} (\code{hclust}),
\item \code{pcoa} (list from \code{cmdscale}), \code{scores} (data.frame with \code{centrality}),
\item \code{centroid} (numeric), \code{metrics_df} (data.frame with FDis/FRic/RaoQ),
\item \code{plots} (list of ggplots: \code{$dend}, \code{$density_gg}, \code{$centrality_hist}, \code{$metrics_bar}).
}
}
\description{
Computes a Gower dissimilarity matrix on mixed-type traits, performs hierarchical
clustering, runs PCoA, visualizes density/centrality, and summarizes functional
dispersion metrics (FDis, FRic, Rao's Q).
}
\details{
\strong{FRic} is computed as convex-hull volume/area in PCoA space via \code{geometry::convhulln}.
If degenerate, returns \code{NA} with a warning. \strong{Rao's Q} uses Euclidean distances in
reduced PCoA space: \eqn{0.5\sum_{i,j} p_i p_j d_{ij}}.
}
\section{Simulated example}{

Use \code{\link{tdp_simulate_traits}} to generate a small, mixed-type trait table.
}

\examples{
# --- Built-in simulated example for reproducibility (mixed continuous + categorical traits) ---
tdp_simulate_traits <- function(n = 30, seed = NULL) {
  if (!is.null(seed)) set.seed(seed)
  species <- paste0("sp_", seq_len(n))
  # continuous
  t1 <- rnorm(n, 0, 1)
  t2 <- runif(n, -1, 1)
  # ordinal
  t3 <- factor(sample(1:3, n, TRUE), ordered = TRUE)
  # binary
  t4 <- factor(sample(c(0, 1), n, TRUE))
  # categorical
  t5 <- factor(sample(LETTERS[1:4], n, TRUE))
  traits <- data.frame(
    species = species,
    t_len = t1,
    t_mass = t2,
    t_rank = t3,
    t_bin = t4,
    t_cat = t5,
    check.names = FALSE
  )
  abundance <- rexp(n, rate = 1)
  list(traits = traits, abundance = abundance)
}

# Generate simulated traits + abundance
sim_data <- tdp_simulate_traits(n = 25, seed = 123)

# Run pipeline and show combined patchwork
res <- compute_trait_dispersion(
  trait_df = sim_data$traits,
  species_col = "species",
  abundance = sim_data$abundance,
  k = 4,
  pcoa_dims = 2,
  show_density_plot = FALSE,
  show_plots = TRUE
)

# Access metrics
res$metrics_df

# Access a specific plot
res$plots$density_gg

}
